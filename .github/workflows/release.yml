# å‘å¸ƒå’Œéƒ¨ç½²å·¥ä½œæµ
# ç”¨äºŽè‡ªåŠ¨åŒ–ç‰ˆæœ¬å‘å¸ƒå’ŒåŒ…åˆ†å‘

name: Release and Deploy

# è§¦å‘æ¡ä»¶
on:
  push:
    tags:
      - 'v*.*.*'  # ç‰ˆæœ¬æ ‡ç­¾ï¼Œå¦‚ v1.0.0, v2.1.3
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Is this a pre-release?'
        required: false
        type: boolean
        default: false

# çŽ¯å¢ƒå˜é‡
env:
  PYTHONUNBUFFERED: 1
  PYTHONDONTWRITEBYTECODE: 1
  PIP_NO_CACHE_DIR: 1

# æƒé™è®¾ç½®
permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  # é¢„å‘å¸ƒæ£€æŸ¥
  pre-release-check:
    name: Pre-release Validation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      is-prerelease: ${{ steps.version.outputs.is-prerelease }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install numpy>=1.19.0 packaging
        
    - name: Extract version information
      id: version
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          VERSION="${{ github.event.inputs.version }}"
          IS_PRERELEASE="${{ github.event.inputs.prerelease }}"
        elif [[ "${{ github.ref }}" =~ ^refs/tags/v(.*)$ ]]; then
          VERSION="${BASH_REMATCH[1]}"
          if [[ "$VERSION" =~ (alpha|beta|rc) ]]; then
            IS_PRERELEASE="true"
          else
            IS_PRERELEASE="false"
          fi
        else
          echo "Unable to determine version"
          exit 1
        fi
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "is-prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
        echo "Release version: $VERSION (prerelease: $IS_PRERELEASE)"
        
    - name: Validate modules
      run: |
        echo "Validating modules for release..."
        
        # æ£€æŸ¥æ¨¡å—ç‰ˆæœ¬ä¸€è‡´æ€§
        python -c "
        import sys
        version = '${{ steps.version.outputs.version }}'
        
        modules = []
        try:
            import animation
            modules.append(('animation', animation.__version__))
        except ImportError:
            pass
            
        try:
            import composition
            modules.append(('composition', composition.__version__))
        except ImportError:
            pass
            
        try:
            import creation
            modules.append(('creation', creation.__version__))
        except ImportError:
            pass
        
        print(f'Target release version: {version}')
        for name, mod_version in modules:
            print(f'{name} module version: {mod_version}')
            if mod_version != version:
                print(f'âš ï¸  Version mismatch in {name} module')
        
        if not modules:
            print('âŒ No modules found for release')
            sys.exit(1)
        else:
            print(f'âœ… Found {len(modules)} modules ready for release')
        "
        
    - name: Run comprehensive tests
      run: |
        echo "Running comprehensive pre-release tests..."
        
        # è¿è¡Œæ‰€æœ‰æ¨¡å—çš„è‡ªæµ‹è¯•
        python -c "
        import sys
        
        modules = []
        try:
            import animation
            animation._module_self_test()
            modules.append('animation')
            print('âœ… Animation module tests passed')
        except Exception as e:
            print(f'âŒ Animation module tests failed: {e}')
            
        try:
            import composition
            composition._module_self_test()
            modules.append('composition')
            print('âœ… Composition module tests passed')
        except Exception as e:
            print(f'âŒ Composition module tests failed: {e}')
            
        try:
            import creation
            creation._module_self_test()
            modules.append('creation')
            print('âœ… Creation module tests passed')
        except Exception as e:
            print(f'âŒ Creation module tests failed: {e}')
        
        if len(modules) == 0:
            print('âŒ No modules passed tests')
            sys.exit(1)
        else:
            print(f'âœ… {len(modules)} modules passed all tests')
        "

  # æž„å»ºå‘å¸ƒåŒ…
  build-packages:
    name: Build Release Packages
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [pre-release-check]
    
    strategy:
      matrix:
        package: [animation_package, compositionbuild_package, creation_package]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: Install build tools
      run: |
        python -m pip install --upgrade pip
        pip install build twine wheel setuptools
        
    - name: Update package version
      run: |
        VERSION="${{ needs.pre-release-check.outputs.version }}"
        PACKAGE="${{ matrix.package }}"
        
        if [ -d "$PACKAGE" ]; then
          cd "$PACKAGE"
          
          # æ›´æ–° setup.py ä¸­çš„ç‰ˆæœ¬
          if [ -f "setup.py" ] || [ -f "setup_*.py" ]; then
            sed -i "s/version=\"[^\"]*\"/version=\"$VERSION\"/g" setup*.py
          fi
          
          # æ›´æ–° pyproject.toml ä¸­çš„ç‰ˆæœ¬
          if [ -f "pyproject.toml" ]; then
            sed -i "s/version = \"[^\"]*\"/version = \"$VERSION\"/g" pyproject.toml
          fi
          
          echo "Updated $PACKAGE to version $VERSION"
          cd ..
        fi
        
    - name: Build package
      run: |
        PACKAGE="${{ matrix.package }}"
        
        if [ -d "$PACKAGE" ]; then
          cd "$PACKAGE"
          
          echo "Building $PACKAGE..."
          python -m build
          
          echo "Checking package..."
          python -m twine check dist/*
          
          echo "Package $PACKAGE built successfully"
          ls -la dist/
          cd ..
        else
          echo "Package directory $PACKAGE not found, skipping"
        fi
        
    - name: Upload package artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ${{ matrix.package }}-dist
        path: ${{ matrix.package }}/dist/
        retention-days: 30
      if: always()

  # åˆ›å»º GitHub Release
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [pre-release-check, build-packages]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Download all artifacts
      uses: actions/download-artifact@v3
      with:
        path: release-artifacts/
        
    - name: Prepare release assets
      run: |
        mkdir -p release-assets
        
        # æ”¶é›†æ‰€æœ‰æž„å»ºçš„åŒ…
        find release-artifacts/ -name "*.whl" -o -name "*.tar.gz" | while read file; do
          cp "$file" release-assets/
        done
        
        # åˆ›å»ºæºç åŒ…
        tar -czf release-assets/manimlib-modules-source-${{ needs.pre-release-check.outputs.version }}.tar.gz \
          --exclude='.git*' \
          --exclude='__pycache__' \
          --exclude='*.pyc' \
          --exclude='release-*' \
          .
        
        echo "Release assets prepared:"
        ls -la release-assets/
        
    - name: Generate release notes
      run: |
        VERSION="${{ needs.pre-release-check.outputs.version }}"
        
        cat > release-notes.md << EOF
        # Manimlib Modules v$VERSION
        
        ## ðŸ“¦ åŒ…å«çš„æ¨¡å—
        
        - **Animation Module**: æ ¸å¿ƒåŠ¨ç”»åŠŸèƒ½æ¨¡å—
        - **Composition Module**: åŠ¨ç”»ç»„åˆå’Œç¼–æŽ’æ¨¡å—  
        - **Creation Module**: å¯¹è±¡åˆ›å»ºå’Œæ“ä½œæ¨¡å—
        
        ## âœ¨ ä¸»è¦ç‰¹æ€§
        
        - ðŸ çŽ°ä»£ Python 3.8+ å…¼å®¹æ€§
        - ðŸ“ å®Œæ•´çš„ç±»åž‹æ³¨è§£æ”¯æŒ
        - ðŸ“š å…¨é¢çš„æ–‡æ¡£å­—ç¬¦ä¸²
        - ðŸ›¡ï¸ å¢žå¼ºçš„é”™è¯¯å¤„ç†æœºåˆ¶
        - âš¡ æ€§èƒ½ä¼˜åŒ–å’Œæ”¹è¿›
        - ðŸ§ª å¹¿æ³›çš„æµ‹è¯•è¦†ç›–
        - ðŸ“¦ çŽ°ä»£åŒ–çš„åŒ…ç®¡ç†
        
        ## ðŸ”§ å®‰è£…æ–¹æ³•
        
        ### ä»Ž PyPI å®‰è£…ï¼ˆæŽ¨èï¼‰
        \`\`\`bash
        pip install manimlib-animation
        pip install manimlib-composition  
        pip install manimlib-creation
        \`\`\`
        
        ### ä»Žæºç å®‰è£…
        \`\`\`bash
        # ä¸‹è½½å¹¶è§£åŽ‹æºç åŒ…
        tar -xzf manimlib-modules-source-$VERSION.tar.gz
        cd manimlib-modules-source-$VERSION
        
        # å®‰è£…å„ä¸ªæ¨¡å—
        pip install ./animation_package/
        pip install ./compositionbuild_package/
        pip install ./creation_package/
        \`\`\`
        
        ## ðŸ“‹ ç³»ç»Ÿè¦æ±‚
        
        - Python 3.8 æˆ–æ›´é«˜ç‰ˆæœ¬
        - NumPy 1.19.0 æˆ–æ›´é«˜ç‰ˆæœ¬
        - æŽ¨èä½¿ç”¨è™šæ‹ŸçŽ¯å¢ƒ
        
        ## ðŸš€ å¿«é€Ÿå¼€å§‹
        
        \`\`\`python
        # å¯¼å…¥æ¨¡å—
        import animation
        import composition
        import creation
        
        # æŸ¥çœ‹ç‰ˆæœ¬ä¿¡æ¯
        print(f"Animation v{animation.__version__}")
        print(f"Composition v{composition.__version__}")
        print(f"Creation v{creation.__version__}")
        
        # è¿è¡Œç¤ºä¾‹
        animation._usage_example()
        composition._usage_example()
        creation._usage_example()
        \`\`\`
        
        ## ðŸ“– æ–‡æ¡£
        
        è¯¦ç»†æ–‡æ¡£è¯·å‚è€ƒå„æ¨¡å—åŒ…ä¸­çš„ README æ–‡ä»¶å’Œæºç æ³¨é‡Šã€‚
        
        ## ðŸ› é—®é¢˜åé¦ˆ
        
        å¦‚æžœæ‚¨å‘çŽ°ä»»ä½•é—®é¢˜æˆ–æœ‰æ”¹è¿›å»ºè®®ï¼Œè¯·åœ¨ GitHub Issues ä¸­æäº¤ã€‚
        
        ## ðŸ“„ è®¸å¯è¯
        
        æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ï¼Œè¯¦è§ LICENSE æ–‡ä»¶ã€‚
        
        ---
        
        **å®Œæ•´æ›´æ–°æ—¥å¿—**: [CHANGELOG.md](CHANGELOG.md)
        EOF
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ needs.pre-release-check.outputs.version }}
        name: Manimlib Modules v${{ needs.pre-release-check.outputs.version }}
        body_path: release-notes.md
        files: release-assets/*
        prerelease: ${{ needs.pre-release-check.outputs.is-prerelease == 'true' }}
        draft: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # å‘å¸ƒåˆ° PyPIï¼ˆå¯é€‰ï¼‰
  publish-pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [create-release]
    if: github.event_name == 'release' && github.event.action == 'published'
    environment: pypi  # éœ€è¦åœ¨ GitHub è®¾ç½®ä¸­é…ç½®çŽ¯å¢ƒ
    
    strategy:
      matrix:
        package: [animation_package, compositionbuild_package, creation_package]
    
    steps:
    - name: Download package artifacts
      uses: actions/download-artifact@v3
      with:
        name: ${{ matrix.package }}-dist
        path: dist/
        
    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        password: ${{ secrets.PYPI_API_TOKEN }}
        packages-dir: dist/
        skip-existing: true
        verbose: true
      continue-on-error: true  # å…è®¸éƒ¨åˆ†åŒ…å‘å¸ƒå¤±è´¥

  # å‘å¸ƒåŽæ¸…ç†å’Œé€šçŸ¥
  post-release:
    name: Post-release Tasks
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [create-release]
    if: always()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Update development version
      run: |
        VERSION="${{ needs.pre-release-check.outputs.version }}"
        
        # è®¡ç®—ä¸‹ä¸€ä¸ªå¼€å‘ç‰ˆæœ¬
        IFS='.' read -ra VERSION_PARTS <<< "$VERSION"
        MAJOR=${VERSION_PARTS[0]}
        MINOR=${VERSION_PARTS[1]}
        PATCH=${VERSION_PARTS[2]}
        
        NEXT_PATCH=$((PATCH + 1))
        NEXT_DEV_VERSION="$MAJOR.$MINOR.$NEXT_PATCH-dev"
        
        echo "Next development version: $NEXT_DEV_VERSION"
        
        # è¿™é‡Œå¯ä»¥æ·»åŠ æ›´æ–°å¼€å‘ç‰ˆæœ¬çš„é€»è¾‘
        # ä¾‹å¦‚æ›´æ–°æ¨¡å—ä¸­çš„ç‰ˆæœ¬å·ä¸ºå¼€å‘ç‰ˆæœ¬
        
    - name: Generate release summary
      run: |
        echo "=== Release Summary ==="
        echo "Version: ${{ needs.pre-release-check.outputs.version }}"
        echo "Prerelease: ${{ needs.pre-release-check.outputs.is-prerelease }}"
        echo "Release Status: ${{ needs.create-release.result }}"
        
        if [[ "${{ needs.create-release.result }}" == "success" ]]; then
          echo "âœ… Release completed successfully!"
          echo "ðŸŽ‰ Manimlib Modules v${{ needs.pre-release-check.outputs.version }} is now available!"
        else
          echo "âŒ Release failed or was cancelled."
        fi
        
        echo "ðŸ“¦ Available packages:"
        echo "- Animation Module"
        echo "- Composition Module"
        echo "- Creation Module"
        
        echo "ðŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/v${{ needs.pre-release-check.outputs.version }}"