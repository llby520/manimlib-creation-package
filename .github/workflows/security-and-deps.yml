# å®‰å…¨æ£€æŸ¥å’Œä¾èµ–æ›´æ–°å·¥ä½œæµ
# ç”¨äºå®šæœŸæ£€æŸ¥å®‰å…¨æ¼æ´å’Œæ›´æ–°ä¾èµ–

name: Security and Dependencies

# å…¨å±€é»˜è®¤è®¾ç½®
defaults:
  run:
    working-directory: ./creation_package

# è§¦å‘æ¡ä»¶
on:
  schedule:
    # æ¯å‘¨ä¸€å‡Œæ™¨3ç‚¹è¿è¡Œï¼ˆUTCæ—¶é—´ï¼‰
    - cron: '0 3 * * 1'
  push:
    paths:
      - 'requirements*.txt'
      - 'pyproject.toml'
      - 'setup*.py'
      - '.github/workflows/security-and-deps.yml'
  pull_request:
    paths:
      - 'requirements*.txt'
      - 'pyproject.toml'
      - 'setup*.py'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force dependency updates'
        required: false
        type: boolean
        default: false
      security_only:
        description: 'Only run security checks'
        required: false
        type: boolean
        default: false

# ç¯å¢ƒå˜é‡
env:
  PYTHONUNBUFFERED: 1
  PYTHONDONTWRITEBYTECODE: 1

# æƒé™è®¾ç½®
permissions:
  contents: read
  security-events: write
  pull-requests: write
  issues: write

jobs:
  # å®‰å…¨æ¼æ´æ‰«æ
  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install safety bandit semgrep pip-audit
        
    - name: Install project dependencies
      run: |
        # å®‰è£…é¡¹ç›®ä¾èµ–ä»¥è¿›è¡Œå®Œæ•´æ‰«æ
        pip install numpy>=1.19.0
        
        # å®‰è£…å„åŒ…çš„ä¾èµ–ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        for package_dir in animation_package compositionbuild_package creation_package; do
          if [ -d "$package_dir" ] && [ -f "$package_dir/requirements.txt" ]; then
            echo "Installing dependencies from $package_dir"
            pip install -r "$package_dir/requirements.txt"
          fi
        done
        
    - name: Run Safety check (known vulnerabilities)
      run: |
        echo "=== Safety Check - Known Vulnerabilities ==="
        safety check --json --output safety-report.json || true
        safety check || echo "âš ï¸ Safety check found potential vulnerabilities"
      continue-on-error: true
      
    - name: Run pip-audit (dependency vulnerabilities)
      run: |
        echo "=== Pip-audit - Dependency Vulnerabilities ==="
        pip-audit --format=json --output=pip-audit-report.json || true
        pip-audit || echo "âš ï¸ Pip-audit found potential vulnerabilities"
      continue-on-error: true
      
    - name: Run Bandit (code security issues)
      run: |
        echo "=== Bandit - Code Security Analysis ==="
        bandit -r . -f json -o bandit-report.json --exclude='./.git,./build,./dist' || true
        bandit -r . --exclude='./.git,./build,./dist' || echo "âš ï¸ Bandit found potential security issues"
      continue-on-error: true
      
    - name: Run Semgrep (static analysis)
      run: |
        echo "=== Semgrep - Static Security Analysis ==="
        semgrep --config=auto --json --output=semgrep-report.json . || true
        semgrep --config=auto . || echo "âš ï¸ Semgrep found potential issues"
      continue-on-error: true
      
    - name: Generate security summary
      run: |
        echo "=== Security Scan Summary ===" > security-summary.md
        echo "" >> security-summary.md
        
        echo "## ğŸ” æ‰«æç»“æœ" >> security-summary.md
        echo "" >> security-summary.md
        
        # Safety ç»“æœ
        if [ -f "safety-report.json" ]; then
          SAFETY_ISSUES=$(jq length safety-report.json 2>/dev/null || echo "0")
          echo "- **Safety**: $SAFETY_ISSUES ä¸ªå·²çŸ¥æ¼æ´" >> security-summary.md
        fi
        
        # Pip-audit ç»“æœ
        if [ -f "pip-audit-report.json" ]; then
          PIP_AUDIT_ISSUES=$(jq '.vulnerabilities | length' pip-audit-report.json 2>/dev/null || echo "0")
          echo "- **Pip-audit**: $PIP_AUDIT_ISSUES ä¸ªä¾èµ–æ¼æ´" >> security-summary.md
        fi
        
        # Bandit ç»“æœ
        if [ -f "bandit-report.json" ]; then
          BANDIT_HIGH=$(jq '.results | map(select(.issue_severity == "HIGH")) | length' bandit-report.json 2>/dev/null || echo "0")
          BANDIT_MEDIUM=$(jq '.results | map(select(.issue_severity == "MEDIUM")) | length' bandit-report.json 2>/dev/null || echo "0")
          echo "- **Bandit**: $BANDIT_HIGH ä¸ªé«˜å±, $BANDIT_MEDIUM ä¸ªä¸­å±é—®é¢˜" >> security-summary.md
        fi
        
        # Semgrep ç»“æœ
        if [ -f "semgrep-report.json" ]; then
          SEMGREP_ISSUES=$(jq '.results | length' semgrep-report.json 2>/dev/null || echo "0")
          echo "- **Semgrep**: $SEMGREP_ISSUES ä¸ªé™æ€åˆ†æé—®é¢˜" >> security-summary.md
        fi
        
        echo "" >> security-summary.md
        echo "## ğŸ“‹ å»ºè®®" >> security-summary.md
        echo "" >> security-summary.md
        echo "1. å®šæœŸæ›´æ–°ä¾èµ–åŒ…åˆ°æœ€æ–°å®‰å…¨ç‰ˆæœ¬" >> security-summary.md
        echo "2. å…³æ³¨é«˜å±å’Œä¸­å±å®‰å…¨é—®é¢˜" >> security-summary.md
        echo "3. å®¡æŸ¥ä»£ç ä¸­çš„æ½œåœ¨å®‰å…¨é£é™©" >> security-summary.md
        echo "4. ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒéš”ç¦»é¡¹ç›®ä¾èµ–" >> security-summary.md
        
        cat security-summary.md
        
    - name: Upload security reports
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: |
          *-report.json
          security-summary.md
        retention-days: 30
      if: always()

  # ä¾èµ–æ£€æŸ¥å’Œæ›´æ–°
  dependency-check:
    name: Dependency Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event.inputs.security_only != 'true'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: Install dependency tools
      run: |
        python -m pip install --upgrade pip
        pip install pip-tools pipdeptree outdated
        
    - name: Analyze current dependencies
      run: |
        echo "=== Current Dependency Analysis ==="
        
        # å®‰è£…å½“å‰ä¾èµ–
        pip install numpy>=1.19.0
        
        # æ˜¾ç¤ºä¾èµ–æ ‘
        echo "## ä¾èµ–æ ‘:"
        pipdeptree
        
        echo "## è¿‡æ—¶çš„åŒ…:"
        pip list --outdated
        
        # æ£€æŸ¥å„åŒ…ç›®å½•çš„ä¾èµ–
        for package_dir in animation_package compositionbuild_package creation_package; do
          if [ -d "$package_dir" ]; then
            echo "\n=== $package_dir Dependencies ==="
            
            if [ -f "$package_dir/requirements.txt" ]; then
              echo "Requirements.txt:"
              cat "$package_dir/requirements.txt"
            fi
            
            if [ -f "$package_dir/pyproject.toml" ]; then
              echo "Pyproject.toml dependencies:"
              grep -A 10 "\[project.dependencies\]" "$package_dir/pyproject.toml" || true
            fi
          fi
        done
        
    - name: Check for dependency updates
      run: |
        echo "=== Checking for Dependency Updates ==="
        
        # åˆ›å»ºä¾èµ–æ›´æ–°æŠ¥å‘Š
        echo "# ä¾èµ–æ›´æ–°æŠ¥å‘Š" > dependency-update-report.md
        echo "" >> dependency-update-report.md
        echo "ç”Ÿæˆæ—¶é—´: $(date)" >> dependency-update-report.md
        echo "" >> dependency-update-report.md
        
        # æ£€æŸ¥ NumPy æ›´æ–°
        echo "## ğŸ” æ ¸å¿ƒä¾èµ–æ£€æŸ¥" >> dependency-update-report.md
        echo "" >> dependency-update-report.md
        
        CURRENT_NUMPY=$(python -c "import numpy; print(numpy.__version__)")
        LATEST_NUMPY=$(pip index versions numpy | head -1 | cut -d' ' -f2 | tr -d '()')
        
        echo "- **NumPy**: å½“å‰ $CURRENT_NUMPY, æœ€æ–° $LATEST_NUMPY" >> dependency-update-report.md
        
        if [ "$CURRENT_NUMPY" != "$LATEST_NUMPY" ]; then
          echo "  - âš ï¸ æœ‰æ–°ç‰ˆæœ¬å¯ç”¨" >> dependency-update-report.md
        else
          echo "  - âœ… å·²æ˜¯æœ€æ–°ç‰ˆæœ¬" >> dependency-update-report.md
        fi
        
        echo "" >> dependency-update-report.md
        echo "## ğŸ“¦ å¼€å‘ä¾èµ–å»ºè®®" >> dependency-update-report.md
        echo "" >> dependency-update-report.md
        echo "å»ºè®®å®šæœŸæ›´æ–°ä»¥ä¸‹å¼€å‘ä¾èµ–:" >> dependency-update-report.md
        echo "- pytest (æµ‹è¯•æ¡†æ¶)" >> dependency-update-report.md
        echo "- black (ä»£ç æ ¼å¼åŒ–)" >> dependency-update-report.md
        echo "- mypy (ç±»å‹æ£€æŸ¥)" >> dependency-update-report.md
        echo "- flake8 (ä»£ç é£æ ¼æ£€æŸ¥)" >> dependency-update-report.md
        echo "- bandit (å®‰å…¨æ£€æŸ¥)" >> dependency-update-report.md
        
        cat dependency-update-report.md
        
    - name: Generate dependency update suggestions
      run: |
        echo "=== Dependency Update Suggestions ===" > update-suggestions.md
        echo "" >> update-suggestions.md
        
        echo "## ğŸ”„ å»ºè®®çš„æ›´æ–°å‘½ä»¤" >> update-suggestions.md
        echo "" >> update-suggestions.md
        echo "### æ ¸å¿ƒä¾èµ–æ›´æ–°" >> update-suggestions.md
        echo "\`\`\`bash" >> update-suggestions.md
        echo "pip install --upgrade numpy" >> update-suggestions.md
        echo "\`\`\`" >> update-suggestions.md
        echo "" >> update-suggestions.md
        
        echo "### å¼€å‘ä¾èµ–æ›´æ–°" >> update-suggestions.md
        echo "\`\`\`bash" >> update-suggestions.md
        echo "pip install --upgrade pytest black mypy flake8 bandit" >> update-suggestions.md
        echo "pip install --upgrade pip-tools pipdeptree safety" >> update-suggestions.md
        echo "\`\`\`" >> update-suggestions.md
        echo "" >> update-suggestions.md
        
        echo "### åŒ…æ„å»ºå·¥å…·æ›´æ–°" >> update-suggestions.md
        echo "\`\`\`bash" >> update-suggestions.md
        echo "pip install --upgrade build twine wheel setuptools" >> update-suggestions.md
        echo "\`\`\`" >> update-suggestions.md
        
        cat update-suggestions.md
        
    - name: Upload dependency reports
      uses: actions/upload-artifact@v3
      with:
        name: dependency-reports
        path: |
          dependency-update-report.md
          update-suggestions.md
        retention-days: 30

  # å…¼å®¹æ€§æµ‹è¯•
  compatibility-test:
    name: Compatibility Test
    runs-on: ubuntu-latest
    timeout-minutes: 25
    if: github.event.inputs.security_only != 'true'
    
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']
        numpy-version: ['1.19.*', '1.21.*', '1.24.*', 'latest']
        exclude:
          # Python 3.12 ä¸æŸäº›æ—§ç‰ˆæœ¬ NumPy ä¸å…¼å®¹
          - python-version: '3.12'
            numpy-version: '1.19.*'
          - python-version: '3.12'
            numpy-version: '1.21.*'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Install NumPy ${{ matrix.numpy-version }}
      run: |
        python -m pip install --upgrade pip
        
        if [ "${{ matrix.numpy-version }}" = "latest" ]; then
          pip install numpy
        else
          pip install "numpy==${{ matrix.numpy-version }}"
        fi
        
    - name: Test module compatibility
      run: |
        echo "Testing Python ${{ matrix.python-version }} with NumPy ${{ matrix.numpy-version }}"
        
        python -c "
        import sys
        import numpy as np
        print(f'Python: {sys.version}')
        print(f'NumPy: {np.__version__}')
        
        # æµ‹è¯•æ¨¡å—å¯¼å…¥
        modules_tested = []
        
        try:
            import animation
            print(f'âœ… Animation v{animation.__version__} - Compatible')
            modules_tested.append('animation')
        except Exception as e:
            print(f'âŒ Animation - Error: {e}')
        
        try:
            import composition
            print(f'âœ… Composition v{composition.__version__} - Compatible')
            modules_tested.append('composition')
        except Exception as e:
            print(f'âŒ Composition - Error: {e}')
        
        try:
            import creation
            print(f'âœ… Creation v{creation.__version__} - Compatible')
            modules_tested.append('creation')
        except Exception as e:
            print(f'âŒ Creation - Error: {e}')
        
        print(f'\nCompatibility Summary: {len(modules_tested)}/3 modules compatible')
        "
      continue-on-error: true

  # åˆ›å»ºé—®é¢˜æŠ¥å‘Š
  create-issue:
    name: Create Security/Dependency Issue
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [security-scan, dependency-check]
    if: always() && github.event_name == 'schedule'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download reports
      uses: actions/download-artifact@v3
      with:
        path: reports/
      continue-on-error: true
      
    - name: Check if issue needed
      id: check-issue
      run: |
        NEED_ISSUE="false"
        ISSUE_TITLE=""
        ISSUE_BODY=""
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å®‰å…¨é—®é¢˜
        if [ -f "reports/security-reports/security-summary.md" ]; then
          if grep -q "ä¸ªå·²çŸ¥æ¼æ´\|ä¸ªä¾èµ–æ¼æ´\|ä¸ªé«˜å±" reports/security-reports/security-summary.md; then
            NEED_ISSUE="true"
            ISSUE_TITLE="ğŸ”’ å®‰å…¨æ¼æ´æ£€æµ‹æŠ¥å‘Š - $(date +%Y-%m-%d)"
          fi
        fi
        
        # æ£€æŸ¥æ˜¯å¦æœ‰ä¾èµ–æ›´æ–°
        if [ -f "reports/dependency-reports/dependency-update-report.md" ]; then
          if grep -q "æœ‰æ–°ç‰ˆæœ¬å¯ç”¨" reports/dependency-reports/dependency-update-report.md; then
            if [ "$NEED_ISSUE" = "false" ]; then
              NEED_ISSUE="true"
              ISSUE_TITLE="ğŸ“¦ ä¾èµ–æ›´æ–°å»ºè®® - $(date +%Y-%m-%d)"
            else
              ISSUE_TITLE="ğŸ”’ğŸ“¦ å®‰å…¨å’Œä¾èµ–æ›´æ–°æŠ¥å‘Š - $(date +%Y-%m-%d)"
            fi
          fi
        fi
        
        echo "need-issue=$NEED_ISSUE" >> $GITHUB_OUTPUT
        echo "issue-title=$ISSUE_TITLE" >> $GITHUB_OUTPUT
        
    - name: Create issue
      if: steps.check-issue.outputs.need-issue == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          
          let body = '# è‡ªåŠ¨å®‰å…¨å’Œä¾èµ–æ£€æŸ¥æŠ¥å‘Š\n\n';
          body += `ç”Ÿæˆæ—¶é—´: ${new Date().toISOString()}\n\n`;
          
          // æ·»åŠ å®‰å…¨æŠ¥å‘Š
          try {
            const securitySummary = fs.readFileSync('reports/security-reports/security-summary.md', 'utf8');
            body += '## ğŸ”’ å®‰å…¨æ£€æŸ¥ç»“æœ\n\n';
            body += securitySummary + '\n\n';
          } catch (e) {
            console.log('No security summary found');
          }
          
          // æ·»åŠ ä¾èµ–æŠ¥å‘Š
          try {
            const depReport = fs.readFileSync('reports/dependency-reports/dependency-update-report.md', 'utf8');
            body += '## ğŸ“¦ ä¾èµ–æ£€æŸ¥ç»“æœ\n\n';
            body += depReport + '\n\n';
          } catch (e) {
            console.log('No dependency report found');
          }
          
          // æ·»åŠ æ›´æ–°å»ºè®®
          try {
            const updateSuggestions = fs.readFileSync('reports/dependency-reports/update-suggestions.md', 'utf8');
            body += '## ğŸ”„ æ›´æ–°å»ºè®®\n\n';
            body += updateSuggestions + '\n\n';
          } catch (e) {
            console.log('No update suggestions found');
          }
          
          body += '## ğŸ“‹ å¤„ç†å»ºè®®\n\n';
          body += '1. å®¡æŸ¥ä¸Šè¿°å®‰å…¨å’Œä¾èµ–é—®é¢˜\n';
          body += '2. ä¼˜å…ˆå¤„ç†é«˜å±å®‰å…¨æ¼æ´\n';
          body += '3. æµ‹è¯•ä¾èµ–æ›´æ–°çš„å…¼å®¹æ€§\n';
          body += '4. æ›´æ–°ç›¸å…³æ–‡æ¡£å’Œæµ‹è¯•\n\n';
          body += '---\n';
          body += '*æ­¤æŠ¥å‘Šç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ*';
          
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: '${{ steps.check-issue.outputs.issue-title }}',
            body: body,
            labels: ['security', 'dependencies', 'automated']
          });

  # æ€»ç»“
  summary:
    name: Security and Dependencies Summary
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [security-scan, dependency-check, compatibility-test]
    if: always()
    
    steps:
    - name: Generate summary
      run: |
        echo "=== Security and Dependencies Summary ==="
        echo "Security Scan: ${{ needs.security-scan.result }}"
        echo "Dependency Check: ${{ needs.dependency-check.result }}"
        echo "Compatibility Test: ${{ needs.compatibility-test.result }}"
        
        if [[ "${{ needs.security-scan.result }}" == "success" ]]; then
          echo "âœ… å®‰å…¨æ‰«æå®Œæˆ"
        else
          echo "âš ï¸ å®‰å…¨æ‰«æå‘ç°é—®é¢˜æˆ–å¤±è´¥"
        fi
        
        if [[ "${{ needs.dependency-check.result }}" == "success" ]]; then
          echo "âœ… ä¾èµ–æ£€æŸ¥å®Œæˆ"
        else
          echo "âš ï¸ ä¾èµ–æ£€æŸ¥å‘ç°é—®é¢˜æˆ–å¤±è´¥"
        fi
        
        if [[ "${{ needs.compatibility-test.result }}" == "success" ]]; then
          echo "âœ… å…¼å®¹æ€§æµ‹è¯•é€šè¿‡"
        else
          echo "âš ï¸ å…¼å®¹æ€§æµ‹è¯•å‘ç°é—®é¢˜"
        fi
        
        echo "\nğŸ“Š å»ºè®®å®šæœŸè¿è¡Œæ­¤å·¥ä½œæµä»¥ä¿æŒé¡¹ç›®å®‰å…¨æ€§å’Œä¾èµ–çš„æœ€æ–°çŠ¶æ€ã€‚"