# GitHub Actions å·¥ä½œæµæ¨¡æ¿
# è¿™æ˜¯ä¸€ä¸ªå¯å®šåˆ¶çš„æ¨¡æ¿ï¼Œç”¨äºåˆ›å»ºæ–°çš„å·¥ä½œæµ

name: Custom Workflow Template

# ğŸ”§ è§¦å‘æ¡ä»¶é…ç½®
# æ ¹æ®éœ€è¦ä¿®æ”¹ä»¥ä¸‹è§¦å‘æ¡ä»¶
on:
  push:
    branches: [ main, develop ]  # ä¿®æ”¹ä¸ºæ‚¨çš„åˆ†æ”¯åç§°
    paths:
      - '*.py'                   # ç›‘æ§çš„æ–‡ä»¶ç±»å‹
      - 'requirements*.txt'
      - 'pyproject.toml'
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'          # å®šæ—¶è¿è¡Œï¼šæ¯å¤©å‡Œæ™¨2ç‚¹
  workflow_dispatch:             # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      custom_param:
        description: 'è‡ªå®šä¹‰å‚æ•°'
        required: false
        type: string
        default: 'default_value'

# ğŸŒ ç¯å¢ƒå˜é‡
env:
  PYTHONUNBUFFERED: 1
  PYTHONDONTWRITEBYTECODE: 1
  # æ·»åŠ æ‚¨çš„è‡ªå®šä¹‰ç¯å¢ƒå˜é‡
  CUSTOM_ENV_VAR: 'custom_value'

# ğŸ” æƒé™è®¾ç½®
permissions:
  contents: read               # æ ¹æ®éœ€è¦è°ƒæ•´æƒé™
  # issues: write
  # pull-requests: write
  # security-events: write

# ğŸš¦ å¹¶å‘æ§åˆ¶
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ğŸ“‹ ä½œä¸šæ¨¡æ¿ 1: åŸºç¡€æ£€æŸ¥
  basic-checks:
    name: Basic Checks
    runs-on: ubuntu-latest     # å¯é€‰: windows-latest, macos-latest
    timeout-minutes: 10        # æ ¹æ®éœ€è¦è°ƒæ•´è¶…æ—¶æ—¶é—´
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'  # ä¿®æ”¹ä¸ºæ‚¨éœ€è¦çš„ Python ç‰ˆæœ¬
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # å®‰è£…æ‚¨çš„é¡¹ç›®ä¾èµ–
        pip install numpy>=1.19.0
        # pip install -r requirements.txt
        
    - name: Run basic checks
      run: |
        echo "=== åŸºç¡€æ£€æŸ¥ ==="
        python --version
        pip list
        
        # æ·»åŠ æ‚¨çš„æ£€æŸ¥å‘½ä»¤
        python -c "import sys; print(f'Python: {sys.version}')"
        
        # ç¤ºä¾‹ï¼šæ¨¡å—å¯¼å…¥æµ‹è¯•
        # python -c "import your_module; print('æ¨¡å—å¯¼å…¥æˆåŠŸ')"
        
    - name: Custom step
      run: |
        echo "è‡ªå®šä¹‰æ­¥éª¤"
        echo "å‚æ•°å€¼: ${{ github.event.inputs.custom_param }}"
        # æ·»åŠ æ‚¨çš„è‡ªå®šä¹‰é€»è¾‘
      continue-on-error: true    # å…è®¸æ­¤æ­¥éª¤å¤±è´¥è€Œä¸å½±å“æ•´ä¸ªä½œä¸š

  # ğŸ“‹ ä½œä¸šæ¨¡æ¿ 2: å¤šç‰ˆæœ¬æµ‹è¯•
  multi-version-test:
    name: Test Python ${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    
    strategy:
      fail-fast: false          # ä¸å› å•ä¸ªæµ‹è¯•å¤±è´¥è€Œåœæ­¢æ‰€æœ‰æµ‹è¯•
      matrix:
        os: [ubuntu-latest]      # æ ¹æ®éœ€è¦æ·»åŠ : windows-latest, macos-latest
        python-version: ['3.9', '3.10', '3.11']  # ä¿®æ”¹ä¸ºæ‚¨æ”¯æŒçš„ç‰ˆæœ¬
        # å¯ä»¥æ·»åŠ å…¶ä»–çŸ©é˜µç»´åº¦
        # dependency-version: ['1.0', '2.0']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # æ ¹æ®çŸ©é˜µå‚æ•°å®‰è£…ä¸åŒç‰ˆæœ¬çš„ä¾èµ–
        pip install numpy>=1.19.0
        
    - name: Run tests
      run: |
        echo "æµ‹è¯• Python ${{ matrix.python-version }} on ${{ matrix.os }}"
        # æ·»åŠ æ‚¨çš„æµ‹è¯•å‘½ä»¤
        # python -m pytest
        # python -m unittest discover
        
        # ç¤ºä¾‹æµ‹è¯•
        python -c "
        import sys
        print(f'Python: {sys.version}')
        print('æµ‹è¯•é€šè¿‡')
        "

  # ğŸ“‹ ä½œä¸šæ¨¡æ¿ 3: æ¡ä»¶æ‰§è¡Œ
  conditional-job:
    name: Conditional Job
    runs-on: ubuntu-latest
    timeout-minutes: 15
    # åªåœ¨ç‰¹å®šæ¡ä»¶ä¸‹è¿è¡Œ
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [basic-checks]        # ä¾èµ–å…¶ä»–ä½œä¸šå®Œæˆ
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Conditional step
      if: contains(github.event.head_commit.message, '[deploy]')
      run: |
        echo "æ£€æµ‹åˆ°éƒ¨ç½²æ ‡è®°ï¼Œæ‰§è¡Œéƒ¨ç½²ç›¸å…³ä»»åŠ¡"
        # æ·»åŠ éƒ¨ç½²é€»è¾‘
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: build-artifacts
        path: |
          dist/
          build/
        retention-days: 7        # ä¿ç•™å¤©æ•°
      if: always()               # å³ä½¿å‰é¢æ­¥éª¤å¤±è´¥ä¹Ÿä¸Šä¼ 

  # ğŸ“‹ ä½œä¸šæ¨¡æ¿ 4: ä½¿ç”¨ Secrets
  secure-job:
    name: Secure Operations
    runs-on: ubuntu-latest
    timeout-minutes: 10
    # åªåœ¨å—ä¿æŠ¤çš„ç¯å¢ƒä¸­è¿è¡Œ
    environment: production      # éœ€è¦åœ¨ GitHub è®¾ç½®ä¸­é…ç½®ç¯å¢ƒ
    if: github.event_name == 'release'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Use secrets
      run: |
        echo "ä½¿ç”¨åŠ å¯†çš„ secrets"
        # æ³¨æ„ï¼šä¸è¦åœ¨æ—¥å¿—ä¸­è¾“å‡º secrets çš„å€¼
        # echo "API Key: ${{ secrets.API_KEY }}"  # âŒ é”™è¯¯åšæ³•
        
        if [ -n "${{ secrets.API_KEY }}" ]; then
          echo "âœ… API Key å·²é…ç½®"
        else
          echo "âŒ API Key æœªé…ç½®"
        fi
      env:
        API_KEY: ${{ secrets.API_KEY }}  # é€šè¿‡ç¯å¢ƒå˜é‡ä½¿ç”¨ secrets

  # ğŸ“‹ ä½œä¸šæ¨¡æ¿ 5: å¤–éƒ¨æœåŠ¡é›†æˆ
  external-service:
    name: External Service Integration
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    # ä½¿ç”¨æœåŠ¡å®¹å™¨
    services:
      redis:
        image: redis:latest
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Test service connection
      run: |
        # æµ‹è¯•ä¸æœåŠ¡å®¹å™¨çš„è¿æ¥
        sudo apt-get update
        sudo apt-get install -y redis-tools
        redis-cli -h localhost ping
        
    - name: Integration tests
      run: |
        echo "è¿è¡Œé›†æˆæµ‹è¯•"
        # æ·»åŠ ä¸å¤–éƒ¨æœåŠ¡çš„é›†æˆæµ‹è¯•

  # ğŸ“‹ ä½œä¸šæ¨¡æ¿ 6: ç»“æœæ±‡æ€»
  summary:
    name: Workflow Summary
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [basic-checks, multi-version-test, conditional-job]
    if: always()                 # æ€»æ˜¯è¿è¡Œï¼Œå³ä½¿å‰é¢çš„ä½œä¸šå¤±è´¥
    
    steps:
    - name: Generate summary
      run: |
        echo "=== å·¥ä½œæµæ‰§è¡Œæ‘˜è¦ ==="
        echo "Basic Checks: ${{ needs.basic-checks.result }}"
        echo "Multi-version Test: ${{ needs.multi-version-test.result }}"
        echo "Conditional Job: ${{ needs.conditional-job.result }}"
        
        # æ ¹æ®ç»“æœè®¾ç½®çŠ¶æ€
        if [[ "${{ needs.basic-checks.result }}" == "success" && "${{ needs.multi-version-test.result }}" == "success" ]]; then
          echo "âœ… å·¥ä½œæµæ‰§è¡ŒæˆåŠŸ"
          echo "status=success" >> $GITHUB_OUTPUT
        else
          echo "âŒ å·¥ä½œæµæ‰§è¡Œå¤±è´¥"
          echo "status=failure" >> $GITHUB_OUTPUT
        fi
        
    - name: Create issue on failure
      if: needs.basic-checks.result == 'failure' || needs.multi-version-test.result == 'failure'
      uses: actions/github-script@v6
      with:
        script: |
          const title = `å·¥ä½œæµå¤±è´¥ - ${context.workflow} (${context.sha.substring(0, 7)})`;
          const body = `
          # å·¥ä½œæµæ‰§è¡Œå¤±è´¥
          
          **å·¥ä½œæµ**: ${context.workflow}
          **åˆ†æ”¯**: ${context.ref}
          **æäº¤**: ${context.sha}
          **è§¦å‘è€…**: ${context.actor}
          
          ## å¤±è´¥çš„ä½œä¸š
          
          - Basic Checks: ${{ needs.basic-checks.result }}
          - Multi-version Test: ${{ needs.multi-version-test.result }}
          
          è¯·æ£€æŸ¥å·¥ä½œæµæ—¥å¿—å¹¶ä¿®å¤ç›¸å…³é—®é¢˜ã€‚
          
          [æŸ¥çœ‹å·¥ä½œæµè¿è¡Œ](${context.payload.repository.html_url}/actions/runs/${context.runId})
          `;
          
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['bug', 'ci-failure']
          });

# ğŸ“ ä½¿ç”¨è¯´æ˜
#
# 1. å¤åˆ¶æ­¤æ¨¡æ¿å¹¶é‡å‘½åä¸ºæ‚¨çš„å·¥ä½œæµåç§°
# 2. ä¿®æ”¹è§¦å‘æ¡ä»¶ã€ç¯å¢ƒå˜é‡å’Œæƒé™è®¾ç½®
# 3. æ ¹æ®éœ€è¦æ·»åŠ ã€åˆ é™¤æˆ–ä¿®æ”¹ä½œä¸š
# 4. é…ç½®å¿…è¦çš„ Secrets å’Œç¯å¢ƒ
# 5. æµ‹è¯•å·¥ä½œæµå¹¶æ ¹æ®éœ€è¦è¿›è¡Œè°ƒæ•´
#
# ğŸ’¡ æç¤º:
# - ä½¿ç”¨ `continue-on-error: true` å…è®¸æ­¥éª¤å¤±è´¥
# - ä½¿ç”¨ `if` æ¡ä»¶æ§åˆ¶ä½œä¸šå’Œæ­¥éª¤çš„æ‰§è¡Œ
# - ä½¿ç”¨ `needs` å®šä¹‰ä½œä¸šä¾èµ–å…³ç³»
# - ä½¿ç”¨ `strategy.matrix` è¿›è¡Œå¤šç»´åº¦æµ‹è¯•
# - ä½¿ç”¨ `timeout-minutes` é˜²æ­¢ä½œä¸šæ— é™è¿è¡Œ
# - ä½¿ç”¨ `upload-artifact` ä¿å­˜æ„å»ºäº§ç‰©
# - ä½¿ç”¨ `environment` ä¿æŠ¤æ•æ„Ÿæ“ä½œ
#
# ğŸ”— å‚è€ƒèµ„æº:
# - GitHub Actions æ–‡æ¡£: https://docs.github.com/en/actions
# - å·¥ä½œæµè¯­æ³•: https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions
# - å¯ç”¨çš„ Actions: https://github.com/marketplace?type=actions